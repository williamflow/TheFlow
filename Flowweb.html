<!--
    Flowweb.html part of TheFlow
    Copyright (C) 2018  williamflow

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script>
            class Node {
                constructor(identity) {
                    this.identity = identity
                    window.addEventListener(this.identity, this.onreceive.bind(this))
                    this.incoming = []
                }
                onreceive(event) {
                    this.incoming.push(event.detail)
                }
                receive() {
                    if (this.incoming.length > 0) {
                        var data = this.incoming[0]
                        this.incoming = this.incoming.splice(1)
                        return data
                    } else
                        return false
                }
                send(data) {
                    var id = [this.identity]
                    window.dispatchEvent(new CustomEvent("__flow__", { detail: id.concat(data) }))
                }
            }
            class EchoNode extends Node {
                echo() {
                    var data = this.receive()
                    if (data != false) {
                        this.send([data[0]+"2"])
                    }
                    console.log("Looping Echo")
                    setTimeout(this.echo.bind(this), 1000)
                }
            }
            class Flow {
                constructor(identity) {
                    this.identity = identity
                    window.addEventListener("__flow__", this.receive.bind(this))
                }
                receive(event) {
                    console.log("RECEIVED: "+event.detail.join("."))
                    var xmlhttp = new XMLHttpRequest()
                    xmlhttp.onreadystatechange = this.parse.bind(this, xmlhttp)
                    var data = event.detail.pop()
                    var graph = event.detail.splice(1)
                    var path = event.detail.concat([this.identity]).concat(graph).join(".")
                    xmlhttp.open("POST", path, true)
                    xmlhttp.send(data)
                    console.log("ROUTED")
                    console.log(path)
                    console.log(data)
                }
                parse(xmlhttp) {
                    if (xmlhttp.readyState == XMLHttpRequest.DONE && xmlhttp.status == 200) {
                        var response = xmlhttp.response.split("\r\n")
                        response.pop()
                        response.pop()
                        var data = response.splice(1).join("\n")
                        var node = response[0].split(".")
                        var graph = node.splice(1).concat([data])
                        this.send(node, graph)
                    }
                }
                send(node, data) {
                    window.dispatchEvent(new CustomEvent(node, { detail: data }))
                    console.log("SENT: "+node+"."+data)
                }
            }
            var flow = new Flow("__FLOWNAME__")
            var echo = new EchoNode("echo")
            echo.send(["2"])
            setInterval(echo.send.bind(echo, ["e", "data"]), 1000)
            echo.echo()
        </script>
    </head>
    <body></body>
</html>
